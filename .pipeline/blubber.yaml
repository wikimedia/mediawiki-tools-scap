# syntax=docker-registry.wikimedia.org/repos/releng/blubber/buildkit:v0.24.0
#
# A Blubber spec file for Docker containers where the Scap automated test suite
# can be run.

version: v4

runs:
  environment:
    LANG: C.UTF-8

builders:
  - python:
      version: python3

variants:
  python-packages:
    apt:
      packages:
        - python3-venv

  base-buster:
    base: docker-registry.wikimedia.org/wikimedia-buster
    includes: [python-packages]

  base-bullseye:
    base: docker-registry.wikimedia.org/bullseye
    includes: [python-packages]

  base-bookworm:
    base: docker-registry.wikimedia.org/bookworm
    includes: [python-packages]

  verify-deps:
    builders:
      - python:
          # Ensure requirements-*.txt are exhaustive
          no-deps: True
          requirements:
            - verify-requirements.txt
            - requirements-common.txt
            - requirements-deploy.txt
    entrypoint: [echo, "deps check passed"]

  verify-deps-buster:
    includes: [base-buster, verify-deps]
  verify-deps-bullseye:
    includes: [base-bullseye, verify-deps]
  verify-deps-bookworm:
    includes: [base-bookworm, verify-deps]

  test:
    apt:
      packages:
        - git
        - php-cli
        - file
    builders:
      # Set up python venv
      - python:
          requirements: []
      # Set up environments.
      - custom:
          command: [tox, run-parallel, --notest]
          requirements:
            - tox.ini
            - requirements-common.txt
            - requirements-deploy.txt
            - test-requirements.txt
            - docs/requirements.txt
      # Run the tests
      - custom:
          command: [tox]
          requirements: [.]
    entrypoint: [echo, Tests passed during image build]

  test-buster:
    includes: [base-buster, test]
  test-bullseye:
    includes: [base-bullseye, test]
  test-bookworm:
    includes: [base-bookworm, test]

  test-buster-report:
    copies:
      - from: test-buster
        source: /srv/app/test-reports
        destination: /
        test-bullseye-report:
  test-bullseye-report:
    copies:
      - from: test-bullseye
        source: /srv/app/test-reports
        destination: /
  test-bookworm-report:
    copies:
      - from: test-bookworm
        source: /srv/app/test-reports
        destination: /

  build-docs:
    includes: [base-buster]
    apt:
      packages:
        - git
    builders:
      # Set up python venv
      - python:
          requirements: []
      - custom:
          command: [tox, -e, doc]
          requirements: [.]
    entrypoint: [echo, docs are in docs/_build/html]

  docs:
    copies:
      - from: build-docs
        source: /srv/app/docs/_build/html/
        destination: docs/

  binary-dist-deploy-build:
    builders:
      - python:
          requirements: [binary-dist-requirements.txt]
      - custom:
          command: [./build_wheels.sh, requirements-common.txt, requirements-deploy.txt]
          requirements: [.]

  binary-dist-target-build:
    builders:
      - python:
          requirements: [binary-dist-requirements.txt]
      - custom:
          command: [./build_wheels.sh, requirements-common.txt]
          requirements: [.]

  # binary-dist-deploy-buster-build isn't needed as we don't run deployment servers with buster anymore

  binary-dist-target-buster-build:
    includes: [base-buster, binary-dist-target-build]

  binary-dist-deploy-bullseye-build:
    includes: [base-bullseye, binary-dist-deploy-build]

  binary-dist-target-bullseye-build:
    includes: [base-bullseye, binary-dist-target-build]

  binary-dist-deploy-bookworm-build:
    includes: [base-bullseye, binary-dist-deploy-build]

  binary-dist-target-bookworm-build:
    includes: [base-bookworm, binary-dist-target-build]

  binary-dist-target-buster:
    base: docker-registry.wikimedia.org/wikimedia-buster
    copies:
      - from: binary-dist-target-buster-build
        source: /srv/app/wheels
        destination: /wheels

  binary-dist-deploy-bullseye:
    base: docker-registry.wikimedia.org/bullseye
    copies:
      - from: binary-dist-deploy-bullseye-build
        source: /srv/app/wheels
        destination: /wheels

  binary-dist-target-bullseye:
    base: docker-registry.wikimedia.org/bullseye
    copies:
      - from: binary-dist-target-bullseye-build
        source: /srv/app/wheels
        destination: /wheels

  binary-dist-deploy-bookworm:
    base: docker-registry.wikimedia.org/bookworm
    copies:
      - from: binary-dist-deploy-bookworm-build
        source: /srv/app/wheels
        destination: /wheels

  binary-dist-target-bookworm:
    base: docker-registry.wikimedia.org/bookworm
    copies:
      - from: binary-dist-target-bookworm-build
        source: /srv/app/wheels
        destination: /wheels
