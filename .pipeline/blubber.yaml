# syntax=docker-registry.wikimedia.org/repos/releng/blubber/buildkit:v0.20.0
#
# A Blubber spec file for Docker containers where the Scap automated test suite
# can be run.

version: v4

runs:
  environment:
    LANG: C.UTF-8

builders:
  - python:
      version: python3

variants:
  python-packages:
    apt:
      packages:
        - python3-pip

  base-buster:
    base: docker-registry.wikimedia.org/wikimedia-buster
    includes: [python-packages]

  base-bullseye:
    base: docker-registry.wikimedia.org/bullseye
    includes: [python-packages]

  base-bookworm:
    base: docker-registry.wikimedia.org/bookworm
    includes: [python-packages]

  verify-deps:
    builders:
      - python:
          # Ensure requirements.txt is exhaustive
          no-deps: True
          requirements:
            - verify-requirements.txt
            - requirements.txt
    entrypoint: [echo, "deps check passed"]

  verify-deps-buster:
    includes: [base-buster, verify-deps]
  verify-deps-bullseye:
    includes: [base-bullseye, verify-deps]
  verify-deps-bookworm:
    includes: [base-bookworm, verify-deps]

  test:
    apt:
      packages:
        - git
        - php-cli
        - file
        - python3-venv
    builders:
      # This approach works for buster, bullseye, and bookworm.
      # It avoids the externally-managed-environment error from pip3
      # on bookworm by installing tox into a virtualenv.
      - custom:
          command: [python3, -m, venv, /tmp/scap]
      - custom:
          command: [/tmp/scap/bin/pip, install, tox]
      # Set up environments.
      - custom:
          command: [/tmp/scap/bin/tox, run-parallel, --notest]
          requirements:
            - tox.ini
            - requirements.txt
            - test-requirements.txt
            - docs/requirements.txt
      # Run the tests
      - custom:
          command: [/tmp/scap/bin/tox]
          requirements: [.]
    entrypoint: [echo, Tests passed during image build]

  test-buster:
    includes: [base-buster, test]
  test-bullseye:
    includes: [base-bullseye, test]
  test-bookworm:
    includes: [base-bookworm, test]

  test-buster-report:
    copies:
      - from: test-buster
        source: /srv/app/test-reports
        destination: /
        test-bullseye-report:
  test-bullseye-report:
    copies:
      - from: test-bullseye
        source: /srv/app/test-reports
        destination: /
  test-bookworm-report:
    copies:
      - from: test-bookworm
        source: /srv/app/test-reports
        destination: /

  build-docs:
    includes: [test-buster]
    builders:
      - custom:
          command: [/tmp/scap/bin/tox, -e, doc]
          requirements: [.]
    entrypoint: [echo, docs are in docs/_build/html]

  docs:
    copies:
      - from: build-docs
        source: /srv/app/docs/_build/html/
        destination: docs/

  binary-dist-buster-build:
    includes: [base-buster]
    builders:
      - python:
          requirements: [binary-dist-requirements.txt]
      - custom:
          command: [./build_wheels.sh]
          requirements: [.]

  binary-dist-bullseye-build:
    includes: [base-bullseye]
    builders:
      - python:
          requirements: [binary-dist-requirements.txt]
      - custom:
          command: [./build_wheels.sh]
          requirements: [.]

  binary-dist-bookworm-build:
    includes: [base-bookworm]
    builders:
      - python:
          requirements: [binary-dist-requirements.txt]
      - custom:
          command: [./build_wheels.sh]
          requirements: [.]

  binary-dist-buster:
    base: docker-registry.wikimedia.org/wikimedia-buster
    copies:
      - from: binary-dist-buster-build
        source: /srv/app/wheels
        destination: /wheels

  binary-dist-bullseye:
    base: docker-registry.wikimedia.org/bullseye
    copies:
      - from: binary-dist-bullseye-build
        source: /srv/app/wheels
        destination: /wheels

  binary-dist-bookworm:
    base: docker-registry.wikimedia.org/bookworm
    copies:
      - from: binary-dist-bookworm-build
        source: /srv/app/wheels
        destination: /wheels
        
