# syntax=docker-registry.wikimedia.org/repos/releng/blubber/buildkit:v0.16.0
#
# A Blubber spec file for Docker containers where the Scap automated test suite
# can be run.

version: v4

runs:
  environment:
    LANG: C.UTF-8

builders:
  - python:
      version: python3

variants:
  python-packages:
    apt:
      packages:
        - python3-pip

  base-buster:
    base: docker-registry.wikimedia.org/wikimedia-buster
    includes: [python-packages]

  base-bullseye:
    base: docker-registry.wikimedia.org/bullseye
    includes: [python-packages]

  verify-deps:
    builders:
      - python:
          # Ensure requirements.txt is exhaustive
          no-deps: True
          requirements:
            - verify-requirements.txt
            - requirements.txt
    entrypoint: [echo, "deps check passed"]

  verify-deps-buster:
    includes: [base-buster, verify-deps]
  verify-deps-bullseye:
    includes: [base-bullseye, verify-deps]

  test:
    apt:
      packages:
        - git
        - php-cli
        - shellcheck
    copies: [local]
    builders:
      - python:
          # Allow transitive dependencies for test-requirements.txt
          no-deps: False
          requirements:
            - requirements.txt
            - test-requirements.txt
            - docs/requirements.txt
    entrypoint: [scripts/check]
    # runs.insecurely true because pytest writes to .pytest_cache
    # (though this can be altered with a pytest.ini file) and doc
    # build writes to docs/_build
    runs:
      insecurely: True

  test-buster:
    includes: [base-buster, test]
  test-bullseye:
    includes: [base-bullseye, test]

  build-docs:
    includes: [test-buster]
    builders:
      - custom:
          command: [sphinx-build, -W, -b, html, docs/, docs/_build/html]
          requirements: [.]
    entrypoint: [echo, docs are in docs/_build/html]

  docs:
    copies:
      - from: build-docs
        source: /srv/app/docs/_build/html/
        destination: docs/

  binary-dist-buster-build:
    includes: [base-buster]
    builders:
      - python:
          requirements: [binary-dist-requirements.txt]
      - custom:
          command: [./build_wheels.sh]
          requirements: [.]

  binary-dist-bullseye-build:
    includes: [base-bullseye]
    builders:
      - python:
          requirements: [binary-dist-requirements.txt]
      - custom:
          command: [./build_wheels.sh]
          requirements: [.]

  binary-dist-buster:
    base: docker-registry.wikimedia.org/wikimedia-buster
    copies:
      - from: binary-dist-buster-build
        source: /srv/app/wheels
        destination: /wheels

  binary-dist-bullseye:
    base: docker-registry.wikimedia.org/bullseye
    copies:
      - from: binary-dist-bullseye-build
        source: /srv/app/wheels
        destination: /wheels
