{
  "comments": [
    {
      "key": {
        "uuid": "8631fb2e_2b5187c7",
        "filename": "scap/main.py",
        "patchSetId": 3
      },
      "lineNbr": 667,
      "author": {
        "id": 34
      },
      "writtenOn": "2019-05-07T15:33:03Z",
      "side": 1,
      "message": "Given that this involves invoking MediaWiki, I wonder if it should be placed after _invalidate_opcache. E.g. if the sync involves introducing anything in PHP that could alter or add a message (e.g. new extension, new message in module registration, MessageCache hook that overrides a message), then that might need to be applied before we ask MW to repopulate the cache.\n\nOn the other hand, seems like that should also/instead happen when we do the actual l10n rebuild, which happens earlier.\n\nNote that this opcache thing is new for PHP 7. Basically, in HHVM we used its developer mode (not RepoAuth mode) which means files are automatically re-compiled if mtime is changed. And HHVM has a built-in fstat cache to make that performant. PHP 7 doesn\u0027t have that, and as such it was decided to disable opcache validation in favour of explicit clearing of the opcache after each code change.\n\nSee also https://wikitech.wikimedia.org/wiki/Debugging_in_production#Pushing_code_to_a_debug_server",
      "range": {
        "startLine": 667,
        "startChar": 13,
        "endLine": 667,
        "endChar": 33
      },
      "revId": "7b59f5790092c51d9a8bc826758e8ed94d87c800",
      "serverId": "e9e9afe9-4712-486d-8885-f54b72dd1951",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "be8f3472_7da2cc5b",
        "filename": "scap/main.py",
        "patchSetId": 3
      },
      "lineNbr": 667,
      "author": {
        "id": 2321
      },
      "writtenOn": "2019-05-07T20:38:29Z",
      "side": 1,
      "message": "FWIW, there are other places in scap that we shell out to MediaWiki (on the deployment master) before opcache invalidation; e.g., rebuildLocalisationCache.\n\nMight cause problems to do one part before opcache invalidation and another part after?",
      "parentUuid": "8631fb2e_2b5187c7",
      "range": {
        "startLine": 667,
        "startChar": 13,
        "endLine": 667,
        "endChar": 33
      },
      "revId": "7b59f5790092c51d9a8bc826758e8ed94d87c800",
      "serverId": "e9e9afe9-4712-486d-8885-f54b72dd1951",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "1f669b67_d7913219",
        "filename": "scap/main.py",
        "patchSetId": 3
      },
      "lineNbr": 667,
      "author": {
        "id": 5
      },
      "writtenOn": "2019-05-08T21:14:09Z",
      "side": 1,
      "message": "Given that, I think I\u0027ll leave it before the opcache invalidation for now, for consistency. I don\u0027t know what the right order is, but if other places are running maintenance scripts before opcache invalidation as Tyler says, then I\u0027d prefer to do the same thing here unless there\u0027s a strong reason not to (or unless we change it everywhere).",
      "parentUuid": "be8f3472_7da2cc5b",
      "range": {
        "startLine": 667,
        "startChar": 13,
        "endLine": 667,
        "endChar": 33
      },
      "revId": "7b59f5790092c51d9a8bc826758e8ed94d87c800",
      "serverId": "e9e9afe9-4712-486d-8885-f54b72dd1951",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "53433442_8d29dbeb",
        "filename": "scap/main.py",
        "patchSetId": 3
      },
      "lineNbr": 735,
      "author": {
        "id": 2321
      },
      "writtenOn": "2019-05-07T20:38:29Z",
      "side": 1,
      "message": "Might be best to make this a standalone function in scap/tasks.py then call it from here; i.e.:\n\n tasks.clear_message_blobs()\n\nWhile still duplicated invocations, the logic would only live in one place.",
      "revId": "7b59f5790092c51d9a8bc826758e8ed94d87c800",
      "serverId": "e9e9afe9-4712-486d-8885-f54b72dd1951",
      "unresolved": false
    },
    {
      "key": {
        "uuid": "08635b76_cb6a163f",
        "filename": "scap/main.py",
        "patchSetId": 3
      },
      "lineNbr": 735,
      "author": {
        "id": 5
      },
      "writtenOn": "2019-05-08T21:14:09Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "53433442_8d29dbeb",
      "revId": "7b59f5790092c51d9a8bc826758e8ed94d87c800",
      "serverId": "e9e9afe9-4712-486d-8885-f54b72dd1951",
      "unresolved": false
    }
  ]
}