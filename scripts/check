#!/bin/bash

set -euo pipefail

title()
{
    echo
    echo =============================================================================
    echo "$@"
    echo
}

got()
{
    command -v "$1" > /dev/null
}

if got shellcheck
then
    title "shellcheck"
    # shellcheck disable=SC2046
    shellcheck $(find . -type f | grep -vE '^\./(\.git|\.tox|docs/_build)' | xargs grep -l '^#!/bin/.*sh')
fi

if got pytest
then
    title "pytest (unit and other functional tests)"
    python3 -m pytest -q -Werror --ignore=tests/scap/integration
fi

if got flake8
then
    title "flake8 (coding style checks)"
    flake8 --count --show-source --statistics \
           --extend-ignore=W605,E501,E203 \
           --extend-exclude=build,docs,dist,bin,subplot .
fi

if got black
then
    # Black v18 is on Debian 10 (buster), but Lars develops on Debian
    # 11 (bullseye), which has a newer Black, which formats things
    # differently. So we only check formatting if we have a new Black.
    if [ "$(black --version | head -n1 | cut -c8-9)" -ge 20 ]
    then
        title "black (code formatting)"
        black --check --diff . bin/scap
    fi
fi

if got subplot
then
    title "Subplot (acceptance criteria)"
    rm -f test.log test.py
    subplot docgen scap.md -o scap.html
    subplot docgen scap.md -o scap.pdf
    subplot codegen scap.md -o test.py
    python3 test.py --log test.log --save-on-failure fail.tar.gz
fi

if got sphinx-build
then
    title "sphinx (documentation)"
    sphinx-build -q -W -b html docs/ docs/_build/html
fi

title "Oh happy day: all tests pass OK!"
exit 0
